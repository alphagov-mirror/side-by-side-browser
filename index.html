<html>
<head>
  <meta charset="utf-8" />
  <title></title>
  <style>
  </style>
</head>
<body>
<div id="header">
	<div id="status"></div>
</div>
<div class="body">
  <iframe scrolling="yes" id="old" src="http://localhost:8000/" frameborder="0" allowtransparency="true" style="width:49%;height:100%"></iframe>
  <iframe scrolling="yes" id="new" src="" frameborder="0" allowtransparency="true" style="width:49%;height:100%"></iframe>

  <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
  <script>
  (function ($) {
    var PROXY_HOST = 'localhost:8000';
    var MAPPED_HOST = 'www.direct.gov.uk';

    var NULL_MAPPING_URL = 'http://placekitten.com/g/600/600';
    var NO_MAPPINGS_URL = 'http://placekitten.com/g/600/600';

    var curUrl;
    var offDomain = 'Browsing off-domain... no mappings will be shown.';
    var offDomainWarning = "You've now navigated off the DirectGov domain. Clicking OK will reload this page, bringing you back to DirectGov home. Cancelling will allow you to continue, but be aware no updates will occur to the GOV.UK panel.";
    var shownOffDomainWarning = false;

    function updateHeader(content) {
      $('#header').html(content);
    }

    function updateFrame(url) {
      url = url.replace(PROXY_HOST, MAPPED_HOST);

      $.getJSON('/mapping/api/mappings.json', {old_url: url})
        .then(function (data) {
          var m;
          if (typeof data.mappings !== 'undefined' && data.mappings.length > 0) {
            m = data.mappings[0].mapping.new_url;
          } else {
            m = NO_MAPPINGS_URL;
          }
          if (m == null) {
            m = NULL_MAPPING_URL;
          }
          $('#new').attr('src', m);
        });
    }

    function updateUrl() {
      url = $('#old')[0].contentWindow.location.href;
      if (typeof url === 'undefined') {
        if (shownOffDomainWarning) {
          updateHeader(offDomain);
          return;
        }

        if (confirm(offDomainWarning)) {
          location.href = '/browser';
        } else {
          shownOffDomainWarning = true;
          updateHeader(offDomain);
        }
        
      } else if (url != curUrl) {
        updateHeader('URL: <a href="'+ url + '">' + url + '</a>');      
        updateFrame(url);      
        curUrl = url;
      }
    }

    function init() {
      updateTimer = setInterval(updateUrl, 1000);
    }

    $(init);
  }(jQuery));
  </script>
</div>
</body>
<html>
